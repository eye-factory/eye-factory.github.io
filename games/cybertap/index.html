<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CyberTap | eye-factory</title>
<link rel="icon" type="image/png" href="favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #0a0a0f;
  --bg-card: rgba(15, 15, 25, 0.9);
  --text: #e0e0e0;
  --text-sub: #8a8a9a;
  --neon-primary: #00d4ff;
  --neon-secondary: #00ff88;
  --neon-pink: #ff00aa;
  --neon-purple: #8b5cf6;
  --neon-yellow: #ffdd00;
  --neon-orange: #ff8800;
  --font-en: 'Orbitron', sans-serif;
  --font-ja: 'Noto Sans JP', sans-serif;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  touch-action: manipulation;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}

body {
  font-family: var(--font-ja);
  background: var(--bg);
  color: var(--text);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Background image - lowest layer */
.bg-image {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: url('ctap1.png') center center / cover no-repeat;
  opacity: 0.18;
  pointer-events: none;
  z-index: -2;
  transition: opacity 0.4s ease;
}

/* Hide static background during play (GIF only) */
body.playing .bg-image {
  opacity: 0;
}

/* Cyber noise overlay */
.bg-noise {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: -1;
  opacity: 0;
  background: repeating-linear-gradient(
    0deg,
    rgba(0, 212, 255, 0.03) 0px,
    rgba(0, 212, 255, 0.03) 1px,
    transparent 1px,
    transparent 2px
  );
  animation: cyberGlitch 4s infinite;
}

@keyframes cyberGlitch {
  0%, 92%, 94%, 96%, 100% { opacity: 0; }
  92.5% { opacity: 0.8; transform: translateX(2px); }
  93% { opacity: 0; }
  94.5% { opacity: 0.6; transform: translateX(-3px) skewX(1deg); }
  95% { opacity: 0.9; transform: translateX(1px); }
  95.5% { opacity: 0; transform: translateX(0); }
  96.5% { opacity: 0.7; transform: translateY(1px); }
  97% { opacity: 0; transform: translateY(0); }
}

/* Additional scan line effect */
.bg-scanlines {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: -1;
  background: repeating-linear-gradient(
    transparent 0px,
    transparent 3px,
    rgba(0, 0, 0, 0.1) 3px,
    rgba(0, 0, 0, 0.1) 4px
  );
  animation: scanFlicker 8s infinite;
}

@keyframes scanFlicker {
  0%, 89%, 91%, 93%, 95%, 97%, 100% { opacity: 0.3; }
  90% { opacity: 0.5; }
  92% { opacity: 0.2; }
  94% { opacity: 0.6; }
  96% { opacity: 0.4; }
}

/* Background grid */
.bg-grid {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-image:
    linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
  background-size: 50px 50px;
  pointer-events: none;
  z-index: 0;
}

/* Rotate guide for portrait mode */
#rotate-guide {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: var(--bg);
  z-index: 9999;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 40px;
}
#rotate-guide .icon {
  font-size: 80px;
  margin-bottom: 30px;
  animation: rotateHint 2s ease-in-out infinite;
}
@keyframes rotateHint {
  0%, 100% { transform: rotate(0deg); }
  50% { transform: rotate(90deg); }
}
#rotate-guide .message {
  font-family: var(--font-en);
  font-size: 20px;
  color: var(--neon-primary);
  margin-bottom: 10px;
}
#rotate-guide .sub-message {
  font-size: 14px;
  color: var(--text-sub);
}

@media (orientation: portrait) and (max-width: 900px) {
  #rotate-guide { display: flex; }
  #game-container { display: none !important; }
}

/* Game container - Landscape optimized */
#game-container {
  position: relative;
  width: 100%;
  height: 100%;
  max-width: 1200px;
  max-height: 100vh;
  z-index: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Screens */
.screen {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  padding: 20px;
  text-align: center;
  overflow-y: auto;
}
.screen.active { display: flex; }

/* Title screen */
#title-screen .game-title {
  font-family: var(--font-en);
  font-size: clamp(48px, 10vw, 80px);
  font-weight: 900;
  background: linear-gradient(90deg, var(--neon-primary), var(--neon-pink), var(--neon-primary));
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.5));
  margin-bottom: 10px;
  /* Initial state - hidden for animation */
  opacity: 0;
  transform: translateX(-100px);
}
#title-screen.animate .game-title {
  animation: titleSlideIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards, gradientShift 3s ease-in-out 0.8s infinite;
}

@keyframes titleSlideIn {
  0% { opacity: 0; transform: translateX(-100px); }
  100% { opacity: 1; transform: translateX(0); }
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

#title-screen .subtitle {
  font-family: var(--font-en);
  font-size: 14px;
  color: var(--text-sub);
  letter-spacing: 0.3em;
  margin-bottom: 40px;
  /* Initial state - hidden for animation */
  opacity: 0;
  transform: translateX(-80px);
}
#title-screen.animate .subtitle {
  animation: subtitleSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.3s forwards;
}

@keyframes subtitleSlideIn {
  0% { opacity: 0; transform: translateX(-80px); }
  100% { opacity: 1; transform: translateX(0); }
}

.title-buttons {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  justify-content: center;
  /* Initial state - hidden for animation */
  opacity: 0;
  transform: scale(0.5);
}
#title-screen.animate .title-buttons {
  animation: buttonsBounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.7s forwards;
}

@keyframes buttonsBounceIn {
  0% { opacity: 0; transform: scale(0.5); }
  70% { transform: scale(1.1); }
  100% { opacity: 1; transform: scale(1); }
}

/* Volume settings */
.volume-settings {
  margin-top: 30px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 280px;
  /* Initial state - hidden for animation */
  opacity: 0;
  transform: translateY(40px);
}
#title-screen.animate .volume-settings {
  animation: volumeSlideUp 0.5s ease-out 1.1s forwards;
}

@keyframes volumeSlideUp {
  0% { opacity: 0; transform: translateY(40px); }
  100% { opacity: 1; transform: translateY(0); }
}

.volume-row {
  display: flex;
  align-items: center;
  gap: 12px;
}
.volume-label {
  font-family: var(--font-en);
  font-size: 12px;
  color: var(--text-sub);
  width: 55px;
  text-align: right;
}
.volume-slider {
  flex: 1;
  -webkit-appearance: none;
  appearance: none;
  height: 6px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
  outline: none;
}
.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  background: var(--neon-primary);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 0 10px var(--neon-primary);
  transition: transform 0.2s;
}
.volume-slider::-webkit-slider-thumb:hover {
  transform: scale(1.2);
}
.volume-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: var(--neon-primary);
  border-radius: 50%;
  cursor: pointer;
  border: none;
  box-shadow: 0 0 10px var(--neon-primary);
}
.volume-value {
  font-family: var(--font-en);
  font-size: 12px;
  color: var(--neon-primary);
  width: 36px;
  text-align: left;
}

/* Tap to Start screen (all devices - for audio initialization) */
#tap-start-screen {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: var(--bg);
  z-index: 10000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
#tap-start-screen.show {
  display: flex;
}
#tap-start-screen .tap-title {
  font-family: var(--font-en);
  font-size: clamp(32px, 8vw, 56px);
  font-weight: 900;
  color: var(--neon-primary);
  text-shadow: 0 0 20px var(--neon-primary);
  animation: tapPulse 1.5s ease-in-out infinite;
}
#tap-start-screen .tap-hint {
  font-size: 14px;
  color: var(--text-sub);
  margin-top: 20px;
}
@keyframes tapPulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.05); }
}

/* Buttons */
.btn {
  font-family: var(--font-en);
  font-size: 16px;
  font-weight: 700;
  padding: 14px 40px;
  border: 2px solid var(--neon-primary);
  background: transparent;
  color: var(--neon-primary);
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}
.btn:hover, .btn:active {
  background: var(--neon-primary);
  color: #000;
  box-shadow: 0 0 20px var(--neon-primary), 0 0 40px var(--neon-primary);
}
.btn.secondary {
  border-color: var(--neon-pink);
  color: var(--neon-pink);
}
.btn.secondary:hover, .btn.secondary:active {
  background: var(--neon-pink);
  color: #000;
  box-shadow: 0 0 20px var(--neon-pink);
}
.btn.small {
  font-size: 12px;
  padding: 10px 24px;
}

/* Song select - Horizontal layout */
#song-select {
  flex-direction: row;
  padding: 20px 40px;
  gap: 30px;
}
.song-select-left {
  flex: 0 0 auto;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
#song-select .section-title {
  font-family: var(--font-en);
  font-size: 28px;
  font-weight: 700;
  color: var(--neon-primary);
  margin-bottom: 20px;
  text-shadow: 0 0 10px var(--neon-primary);
}

.song-list {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  max-height: 80vh;
  overflow-y: auto;
  padding: 10px;
  align-content: start;
}

.song-item {
  background: var(--bg-card);
  border: 1px solid rgba(0, 212, 255, 0.3);
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: left;
}
.song-item:hover, .song-item.selected {
  border-color: var(--neon-primary);
  box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
  transform: scale(1.02);
}
.song-item .song-title {
  font-family: var(--font-en);
  font-size: 16px;
  font-weight: 700;
  color: var(--neon-primary);
  margin-bottom: 4px;
}
.song-item .song-artist {
  font-size: 12px;
  color: var(--text-sub);
}
.song-item .song-bpm {
  font-family: var(--font-en);
  font-size: 11px;
  color: var(--neon-pink);
  margin-top: 6px;
}

/* Difficulty select - Horizontal layout */
#difficulty-select {
  flex-direction: row;
  gap: 40px;
}
.difficulty-info {
  text-align: center;
}
.difficulty-buttons {
  display: flex;
  flex-direction: row;
  gap: 20px;
  flex-wrap: wrap;
  justify-content: center;
}
.diff-btn {
  font-family: var(--font-en);
  font-size: 18px;
  font-weight: 700;
  padding: 20px 40px;
  border: 2px solid;
  background: transparent;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  min-width: 140px;
}
.diff-btn.easy {
  border-color: var(--neon-secondary);
  color: var(--neon-secondary);
}
.diff-btn.easy:hover {
  background: var(--neon-secondary);
  color: #000;
  box-shadow: 0 0 20px var(--neon-secondary);
}
.diff-btn.normal {
  border-color: var(--neon-yellow);
  color: var(--neon-yellow);
}
.diff-btn.normal:hover {
  background: var(--neon-yellow);
  color: #000;
  box-shadow: 0 0 20px var(--neon-yellow);
}
.diff-btn.hard {
  border-color: var(--neon-pink);
  color: var(--neon-pink);
}
.diff-btn.hard:hover {
  background: var(--neon-pink);
  color: #000;
  box-shadow: 0 0 20px var(--neon-pink);
}

.selected-song-info {
  font-size: 14px;
  color: var(--text-sub);
  margin-bottom: 20px;
}
.selected-song-info strong {
  color: var(--neon-primary);
  font-family: var(--font-en);
  font-size: 24px;
}

/* Play screen */
#play-screen {
  position: relative;
  padding: 0;
  overflow: hidden;
  background: rgba(0, 0, 0, 0.5);
}

/* Play screen GIF background */
#play-bg {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-size: cover;
  background-position: center;
  opacity: 0.09;
  z-index: 0;
  pointer-events: none;
}

#play-area {
  position: absolute;
  top: 60px; left: 0; right: 0; bottom: 30px;
  overflow: hidden;
}

.play-hud {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 60px;
  padding: 10px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0.5));
  z-index: 10;
}
.play-hud .score {
  font-family: var(--font-en);
  font-size: 28px;
  font-weight: 700;
  color: var(--neon-primary);
  text-shadow: 0 0 10px var(--neon-primary);
}
.play-hud .combo {
  font-family: var(--font-en);
  font-size: 16px;
  color: var(--neon-secondary);
}
.play-hud .song-info {
  font-size: 12px;
  color: var(--text-sub);
  text-align: right;
}
.play-hud .song-info .song-name {
  font-family: var(--font-en);
  color: var(--neon-primary);
}

/* Hit circles - Unified cyber design */
.hit-circle {
  position: absolute;
  border-radius: 50%;
  border: 3px solid transparent;
  background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(255, 0, 170, 0.2));
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-en);
  font-weight: 700;
  cursor: pointer;
  animation: circleAppear 0.3s ease-out;
  transform: translate(-50%, -50%);
  /* Gradient border effect */
  background-clip: padding-box;
  position: relative;
}
.hit-circle::before {
  content: '';
  position: absolute;
  top: -3px; left: -3px; right: -3px; bottom: -3px;
  background: linear-gradient(90deg, var(--neon-primary), var(--neon-pink), var(--neon-primary));
  background-size: 200% 100%;
  border-radius: 50%;
  z-index: -1;
  animation: gradientBorder 2s ease-in-out infinite;
}
.hit-circle::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: radial-gradient(circle, rgba(0, 212, 255, 0.1) 0%, rgba(255, 0, 170, 0.1) 100%);
  border-radius: 50%;
  z-index: -1;
}
@keyframes gradientBorder {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}
.hit-circle span {
  background: linear-gradient(90deg, var(--neon-primary), var(--neon-pink));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 8px rgba(0, 212, 255, 0.8));
}
.hit-circle:active {
  transform: translate(-50%, -50%) scale(0.95);
}

/* Medium circle - Normal notes */
.hit-circle.medium {
  width: 70px;
  height: 70px;
  font-size: 18px;
  box-shadow: 0 0 25px rgba(0, 212, 255, 0.5), 0 0 50px rgba(255, 0, 170, 0.3);
}

/* Large circle - Strong beats */
.hit-circle.large {
  width: 100px;
  height: 100px;
  font-size: 24px;
  box-shadow: 0 0 35px rgba(0, 212, 255, 0.6), 0 0 70px rgba(255, 0, 170, 0.4);
}

/* XLarge circle - Accent notes (rare) */
.hit-circle.xlarge {
  width: 130px;
  height: 130px;
  font-size: 32px;
  box-shadow: 0 0 50px rgba(0, 212, 255, 0.8), 0 0 100px rgba(255, 0, 170, 0.6), 0 0 150px rgba(0, 212, 255, 0.3);
}
.hit-circle.xlarge::before {
  animation: gradientBorder 1s ease-in-out infinite;
}

.hit-circle .approach-ring {
  position: absolute;
  border: 2px solid var(--neon-primary);
  border-radius: 50%;
  opacity: 0.7;
  pointer-events: none;
  box-shadow: 0 0 10px var(--neon-primary);
}

/* Approach ring animations for each size */
.hit-circle.medium .approach-ring {
  width: 140px; height: 140px;
  animation: approachMedium 1s linear forwards;
}
.hit-circle.large .approach-ring {
  width: 200px; height: 200px;
  animation: approachLarge 1.2s linear forwards;
}
.hit-circle.xlarge .approach-ring {
  width: 260px; height: 260px;
  animation: approachXLarge 1.5s linear forwards;
  border-width: 3px;
}

/* Ripple effect on tap */
.tap-ripple {
  position: absolute;
  border-radius: 50%;
  border: 3px solid var(--neon-primary);
  pointer-events: none;
  animation: rippleExpand 0.5s ease-out forwards;
  transform: translate(-50%, -50%);
}
.tap-ripple.perfect {
  border-color: var(--neon-secondary);
  box-shadow: 0 0 20px var(--neon-secondary);
}

@keyframes rippleExpand {
  0% { width: 0; height: 0; opacity: 1; }
  100% { width: 200px; height: 200px; opacity: 0; }
}

/* Large ripple effect */
.tap-ripple.large-effect {
  animation: rippleExpandLarge 0.6s ease-out forwards;
}
@keyframes rippleExpandLarge {
  0% { width: 0; height: 0; opacity: 1; }
  100% { width: 300px; height: 300px; opacity: 0; }
}

/* XLarge ripple + flash effect */
.tap-ripple.xlarge-effect {
  animation: rippleExpandXLarge 0.8s ease-out forwards;
  border-width: 5px;
}
@keyframes rippleExpandXLarge {
  0% { width: 0; height: 0; opacity: 1; }
  50% { opacity: 0.8; }
  100% { width: 500px; height: 500px; opacity: 0; }
}

/* Screen flash effect */
.screen-flash {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: radial-gradient(circle, rgba(0, 212, 255, 0.4) 0%, rgba(255, 0, 170, 0.2) 50%, transparent 70%);
  pointer-events: none;
  z-index: 50;
  animation: screenFlash 0.3s ease-out forwards;
}
@keyframes screenFlash {
  0% { opacity: 1; }
  100% { opacity: 0; }
}

/* Particle effect */
.tap-particle {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  pointer-events: none;
  animation: particleBurst 0.6s ease-out forwards;
}
@keyframes particleBurst {
  0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
}

@keyframes circleAppear {
  from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
  to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

@keyframes approachMedium {
  from { width: 140px; height: 140px; opacity: 0.8; }
  to { width: 70px; height: 70px; opacity: 0; }
}
@keyframes approachLarge {
  from { width: 200px; height: 200px; opacity: 0.8; }
  to { width: 100px; height: 100px; opacity: 0; }
}
@keyframes approachXLarge {
  from { width: 260px; height: 260px; opacity: 0.9; }
  to { width: 130px; height: 130px; opacity: 0; }
}

/* Hit feedback - Enhanced */
.hit-feedback {
  position: absolute;
  font-family: var(--font-en);
  font-size: 22px;
  font-weight: 900;
  pointer-events: none;
  transform: translate(-50%, -50%);
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}
.hit-feedback.perfect {
  background: linear-gradient(90deg, #00ff88, #00ffcc, #00ff88);
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 15px #00ff88) drop-shadow(0 0 30px #00ff88);
  animation: feedbackPerfect 0.6s ease-out forwards;
}
.hit-feedback.great {
  background: linear-gradient(90deg, var(--neon-primary), #00ffff, var(--neon-primary));
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 12px var(--neon-primary)) drop-shadow(0 0 25px var(--neon-primary));
  animation: feedbackGreat 0.6s ease-out forwards;
}
.hit-feedback.good {
  background: linear-gradient(90deg, var(--neon-yellow), #ffff00, var(--neon-yellow));
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 10px var(--neon-yellow));
  animation: feedbackGood 0.5s ease-out forwards;
}
.hit-feedback.miss {
  background: linear-gradient(90deg, var(--neon-pink), #ff4488, var(--neon-pink));
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 10px var(--neon-pink));
  animation: feedbackMiss 0.5s ease-out forwards;
}

@keyframes feedbackPerfect {
  0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
  20% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
  40% { transform: translate(-50%, -50%) scale(1.2); }
  100% { transform: translate(-50%, calc(-50% - 40px)) scale(1.3); opacity: 0; }
}
@keyframes feedbackGreat {
  0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
  20% { transform: translate(-50%, -50%) scale(1.4); opacity: 1; }
  100% { transform: translate(-50%, calc(-50% - 35px)) scale(1.2); opacity: 0; }
}
@keyframes feedbackGood {
  0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
  20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
  100% { transform: translate(-50%, calc(-50% - 30px)) scale(1.1); opacity: 0; }
}
@keyframes feedbackMiss {
  0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  50% { transform: translate(-50%, -50%) scale(0.9) rotate(-5deg); }
  100% { transform: translate(-50%, calc(-50% - 20px)) scale(0.8); opacity: 0; }
}

/* Score popup animation */
.score-popup {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  font-family: var(--font-en);
  font-size: 24px;
  font-weight: 900;
  background: linear-gradient(90deg, var(--neon-primary), var(--neon-pink));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 10px var(--neon-primary));
  animation: scorePopup 0.8s ease-out forwards;
  pointer-events: none;
  z-index: 100;
}
@keyframes scorePopup {
  0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
  30% { transform: translateX(-50%) scale(1.3); opacity: 1; }
  100% { transform: translateX(-50%) translateY(-30px) scale(1); opacity: 0; }
}

/* Screen transition fade */
#screen-fade {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: var(--bg);
  z-index: 9998;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}
#screen-fade.active {
  opacity: 1;
  pointer-events: all;
}

/* Result screen - Horizontal layout */
#result-screen {
  flex-direction: row;
  gap: 40px;
  padding: 30px;
}
.result-left {
  display: flex;
  flex-direction: column;
  align-items: center;
}
#result-screen .result-title {
  font-family: var(--font-en);
  font-size: 32px;
  font-weight: 900;
  color: var(--neon-primary);
  margin-bottom: 20px;
  text-shadow: 0 0 20px var(--neon-primary);
}

.result-grade {
  font-family: var(--font-en);
  font-size: 100px;
  font-weight: 900;
  line-height: 1;
  opacity: 0;
  animation: gradeReveal 1s ease-out 0.3s forwards;
}
.grade-s {
  background: linear-gradient(90deg, #00ff88, #00ffcc, #88ff00, #00ff88);
  background-size: 300% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 30px #00ff88) drop-shadow(0 0 60px #00ff88);
  animation: gradeReveal 1s ease-out 0.3s forwards, gradeShineS 2s ease-in-out infinite;
}
.grade-a {
  background: linear-gradient(90deg, var(--neon-primary), #00ffff, var(--neon-primary));
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 25px var(--neon-primary)) drop-shadow(0 0 50px var(--neon-primary));
  animation: gradeReveal 1s ease-out 0.3s forwards, gradeShine 2s ease-in-out infinite;
}
.grade-b {
  background: linear-gradient(90deg, var(--neon-yellow), #ffff00, var(--neon-yellow));
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 20px var(--neon-yellow));
  animation: gradeReveal 1s ease-out 0.3s forwards, gradeShine 2s ease-in-out infinite;
}
.grade-c {
  background: linear-gradient(90deg, var(--neon-pink), #ff4488, var(--neon-pink));
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 15px var(--neon-pink));
  animation: gradeReveal 1s ease-out 0.3s forwards;
}
@keyframes gradeReveal {
  0% { opacity: 0; transform: scale(0.3) rotate(-10deg); }
  50% { opacity: 1; transform: scale(1.2) rotate(5deg); }
  70% { transform: scale(0.95) rotate(-2deg); }
  100% { opacity: 1; transform: scale(1) rotate(0deg); }
}
@keyframes gradeShine {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}
@keyframes gradeShineS {
  0%, 100% { background-position: 0% 50%; filter: drop-shadow(0 0 30px #00ff88) drop-shadow(0 0 60px #00ff88); }
  50% { background-position: 100% 50%; filter: drop-shadow(0 0 50px #00ff88) drop-shadow(0 0 100px #00ffcc); }
}

/* Result score animation */
#result-score {
  animation: resultScoreReveal 0.8s ease-out 0.6s forwards;
  opacity: 0;
}
@keyframes resultScoreReveal {
  0% { opacity: 0; transform: translateY(20px); }
  100% { opacity: 1; transform: translateY(0); }
}

.result-stats {
  background: var(--bg-card);
  border: 1px solid rgba(0, 212, 255, 0.3);
  border-radius: 16px;
  padding: 24px;
  min-width: 260px;
}
.result-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.result-row:last-child { border-bottom: none; }
.result-row .label {
  color: var(--text-sub);
  font-size: 14px;
}
.result-row .value {
  font-family: var(--font-en);
  font-weight: 700;
}
.result-row .value.score {
  font-size: 24px;
  color: var(--neon-primary);
}
.result-row .value.perfect { color: var(--neon-secondary); }
.result-row .value.great { color: var(--neon-primary); }
.result-row .value.good { color: var(--neon-yellow); }
.result-row .value.miss { color: var(--neon-pink); }

.result-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 20px;
}

/* Ranking screen */
#ranking-screen {
  padding: 20px 40px;
  flex-direction: column;
}
.ranking-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  margin-bottom: 10px;
}
.ranking-nav-btn {
  font-family: var(--font-en);
  font-size: 24px;
  width: 40px;
  height: 40px;
  border: 2px solid var(--neon-primary);
  background: transparent;
  color: var(--neon-primary);
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s ease;
}
.ranking-nav-btn:hover {
  background: var(--neon-primary);
  color: #000;
}
.ranking-song-title {
  font-family: var(--font-en);
  font-size: 20px;
  font-weight: 700;
  color: var(--neon-primary);
  min-width: 200px;
  text-align: center;
}
.ranking-diff-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}
.ranking-diff-tab {
  font-family: var(--font-en);
  font-size: 12px;
  padding: 6px 16px;
  border: 1px solid var(--text-sub);
  background: transparent;
  color: var(--text-sub);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
}
.ranking-diff-tab.active {
  border-color: var(--neon-primary);
  color: var(--neon-primary);
  background: rgba(0, 212, 255, 0.1);
}
.ranking-list {
  width: 100%;
  max-width: 500px;
  max-height: 60vh;
  overflow-y: auto;
  margin: 0 auto;
}
.ranking-item {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  background: var(--bg-card);
  border-radius: 8px;
  margin-bottom: 6px;
}
.ranking-item .rank {
  font-family: var(--font-en);
  font-size: 18px;
  font-weight: 700;
  width: 36px;
  color: var(--neon-primary);
}
.ranking-item .rank.gold { color: #ffd700; }
.ranking-item .rank.silver { color: #c0c0c0; }
.ranking-item .rank.bronze { color: #cd7f32; }
.ranking-item .info {
  flex: 1;
  text-align: left;
}
.ranking-item .info .name {
  font-size: 13px;
}
.ranking-item .info .meta {
  font-size: 10px;
  color: var(--text-sub);
}
.ranking-item .score {
  font-family: var(--font-en);
  font-weight: 700;
  color: var(--neon-primary);
}

/* Countdown - Enhanced */
.countdown {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-family: var(--font-en);
  font-size: 120px;
  font-weight: 900;
  background: linear-gradient(90deg, var(--neon-primary), var(--neon-pink), var(--neon-primary));
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 40px var(--neon-primary)) drop-shadow(0 0 80px var(--neon-pink));
  animation: countdownPulse 0.9s ease-in-out;
  z-index: 20;
}
.countdown.go {
  font-size: 140px;
  background: linear-gradient(90deg, #00ff88, #00ffcc, #00ff88);
  filter: drop-shadow(0 0 50px #00ff88) drop-shadow(0 0 100px #00ffcc);
}

@keyframes countdownPulse {
  0% { transform: translate(-50%, -50%) scale(0.3) rotate(-15deg); opacity: 0; }
  40% { transform: translate(-50%, -50%) scale(1.3) rotate(5deg); opacity: 1; }
  70% { transform: translate(-50%, -50%) scale(1.1) rotate(-2deg); }
  100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
}

/* Progress bar */
.progress-bar {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 6px;
  background: rgba(255,255,255,0.1);
}
.progress-bar .fill {
  height: 100%;
  background: linear-gradient(90deg, var(--neon-primary), var(--neon-pink));
  transition: width 0.1s linear;
}

/* Back button */
.back-btn {
  position: absolute;
  top: 15px;
  left: 15px;
  font-family: var(--font-en);
  font-size: 12px;
  padding: 8px 16px;
  border: 1px solid var(--text-sub);
  background: rgba(0,0,0,0.5);
  color: var(--text-sub);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 10;
}
.back-btn:hover {
  border-color: var(--neon-primary);
  color: var(--neon-primary);
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
::-webkit-scrollbar-thumb { background: var(--neon-primary); border-radius: 3px; }

/* No audio warning */
.no-audio-warning {
  background: rgba(255, 0, 170, 0.2);
  border: 1px solid var(--neon-pink);
  border-radius: 8px;
  padding: 10px 16px;
  margin-bottom: 15px;
  font-size: 11px;
  color: var(--neon-pink);
}

/* Mobile landscape adjustments */
@media (max-height: 500px) {
  .play-hud { height: 50px; padding: 8px 15px; }
  .play-hud .score { font-size: 22px; }
  #play-area { top: 50px; bottom: 25px; }
  .countdown { font-size: 80px; }
  .result-grade { font-size: 60px; }
  #result-screen { gap: 20px; padding: 15px; }
  .result-stats { padding: 16px; }
}
</style>
</head>
<body>

<!-- Tap to Start screen (all devices - for audio initialization) -->
<div id="tap-start-screen">
  <div class="tap-title">TAP TO START</div>
  <div class="tap-hint">„Çø„ÉÉ„Éó„Åó„Å¶ÈñãÂßã</div>
</div>

<!-- Screen transition fade -->
<div id="screen-fade"></div>

<div class="bg-image"></div>
<div class="bg-noise"></div>
<div class="bg-scanlines"></div>
<div class="bg-grid"></div>

<!-- Rotate guide for portrait mode -->
<div id="rotate-guide">
  <div class="icon">üì±</div>
  <div class="message">Please Rotate Your Device</div>
  <div class="sub-message">Ê®™ÁîªÈù¢„Åß„Éó„É¨„Ç§„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
</div>

<div id="game-container">
  <!-- Title Screen -->
  <div id="title-screen" class="screen active">
    <h1 class="game-title">CyberTap</h1>
    <p class="subtitle">Rhythm Action Game</p>
    <div class="title-buttons">
      <button class="btn" onclick="showScreen('song-select')">Start</button>
      <button class="btn secondary" onclick="showScreen('ranking')">Ranking</button>
    </div>
    <div class="volume-settings">
      <div class="volume-row">
        <span class="volume-label">Volume</span>
        <input type="range" class="volume-slider" id="master-volume" min="0" max="100" value="80" oninput="updateVolume(this.value)">
        <span class="volume-value" id="volume-value">80%</span>
      </div>
    </div>
  </div>

  <!-- Song Select Screen -->
  <div id="song-select" class="screen">
    <button class="back-btn" onclick="showScreen('title-screen')">Back</button>
    <div class="song-select-left">
      <h2 class="section-title">Select Song</h2>
      <div class="no-audio-warning">BGM not available yet (Tap test mode)</div>
    </div>
    <div class="song-list" id="song-list"></div>
  </div>

  <!-- Difficulty Select Screen -->
  <div id="difficulty-select" class="screen">
    <button class="back-btn" onclick="showScreen('song-select')">Back</button>
    <div class="difficulty-info">
      <h2 class="section-title">Select Difficulty</h2>
      <div class="selected-song-info">
        <strong id="selected-song-name"></strong>
      </div>
    </div>
    <div class="difficulty-buttons">
      <button class="diff-btn easy" onclick="startGame('easy')">Easy</button>
      <button class="diff-btn normal" onclick="startGame('normal')">Normal</button>
      <button class="diff-btn hard" onclick="startGame('hard')">Hard</button>
    </div>
  </div>

  <!-- Play Screen -->
  <div id="play-screen" class="screen">
    <div id="play-bg"></div>
    <div class="play-hud">
      <div>
        <div class="score" id="current-score">0</div>
        <div class="combo" id="current-combo"></div>
      </div>
      <div class="song-info">
        <div class="song-name" id="play-song-name"></div>
        <div id="play-difficulty"></div>
      </div>
    </div>
    <div id="play-area"></div>
    <div class="progress-bar">
      <div class="fill" id="progress-fill"></div>
    </div>
  </div>

  <!-- Result Screen -->
  <div id="result-screen" class="screen">
    <div class="result-left">
      <h2 class="result-title">Result</h2>
      <div class="result-grade" id="result-grade">S</div>
      <div class="result-buttons">
        <button class="btn" onclick="retryGame()">Retry</button>
        <button class="btn secondary" onclick="showScreen('title-screen')">Title</button>
      </div>
    </div>
    <div class="result-stats">
      <div class="result-row">
        <span class="label">Score</span>
        <span class="value score" id="result-score">0</span>
      </div>
      <div class="result-row">
        <span class="label">Max Combo</span>
        <span class="value" id="result-combo">0</span>
      </div>
      <div class="result-row">
        <span class="label">Perfect</span>
        <span class="value perfect" id="result-perfect">0</span>
      </div>
      <div class="result-row">
        <span class="label">Great</span>
        <span class="value great" id="result-great">0</span>
      </div>
      <div class="result-row">
        <span class="label">Good</span>
        <span class="value good" id="result-good">0</span>
      </div>
      <div class="result-row">
        <span class="label">Miss</span>
        <span class="value miss" id="result-miss">0</span>
      </div>
    </div>
  </div>

  <!-- Ranking Screen -->
  <div id="ranking-screen" class="screen">
    <button class="back-btn" onclick="showScreen('title-screen')">Home</button>
    <h2 class="section-title">Ranking</h2>
    <div class="ranking-header">
      <button class="ranking-nav-btn" onclick="changeRankingSong(-1)">&lt;</button>
      <span class="ranking-song-title" id="ranking-song-title">Cyber Rush</span>
      <button class="ranking-nav-btn" onclick="changeRankingSong(1)">&gt;</button>
    </div>
    <div class="ranking-diff-tabs">
      <button class="ranking-diff-tab active" onclick="changeRankingDiff('easy')">Easy</button>
      <button class="ranking-diff-tab" onclick="changeRankingDiff('normal')">Normal</button>
      <button class="ranking-diff-tab" onclick="changeRankingDiff('hard')">Hard</button>
    </div>
    <div class="ranking-list" id="ranking-list"></div>
  </div>
</div>

<script>
// ============================================================
// SONG DATA - Easy to add new songs
// ============================================================
const SONGS = [
  {
    id: 'lumi_zero',
    title: 'Lumi Zero',
    artist: 'eye-factory',
    bpm: 128,
    audioFile: 'lumi_zero.mp3',
    duration: 10,  // Test: 10 seconds
  },
  {
    id: 'neon_drive',
    title: 'Neon Drive',
    artist: 'eye-factory',
    bpm: 128,
    audioFile: null,
    duration: 10,  // Test: 10 seconds
  },
  {
    id: 'digital_pulse',
    title: 'Digital Pulse',
    artist: 'eye-factory',
    bpm: 150,
    audioFile: null,
    duration: 10,  // Test: 10 seconds
  },
  {
    id: 'synth_wave',
    title: 'Synth Wave',
    artist: 'eye-factory',
    bpm: 120,
    audioFile: null,
    duration: 10,  // Test: 10 seconds
  },
];

// Circle sizes configuration (medium, large, xlarge)
const CIRCLE_TYPES = {
  medium: {
    size: 70,
    approachTime: 1000,  // Normal approach
    timingWindow: { perfect: 50, great: 100, good: 180 },
    scoreMultiplier: 1.0, // Normal score
    missWindow: 220,
    effectScale: 1.0,    // Ripple effect scale
  },
  large: {
    size: 100,
    approachTime: 1200,  // Slightly slower
    timingWindow: { perfect: 60, great: 120, good: 200 },
    scoreMultiplier: 1.5, // Higher score for stronger beats
    missWindow: 250,
    effectScale: 1.5,    // Larger ripple
  },
  xlarge: {
    size: 130,
    approachTime: 1500,  // Slow approach for accent
    timingWindow: { perfect: 80, great: 150, good: 250 },
    scoreMultiplier: 3.0, // Highest score for accents
    missWindow: 300,
    effectScale: 2.5,    // Massive ripple + flash
  },
};

// Base scores
const BASE_SCORES = { perfect: 300, great: 200, good: 100 };

// ============================================================
// GAME STATE
// ============================================================
let gameState = {
  currentScreen: 'title-screen',
  selectedSong: null,
  selectedDifficulty: null,
  score: 0,
  combo: 0,
  maxCombo: 0,
  hits: { perfect: 0, great: 0, good: 0, miss: 0 },
  isPlaying: false,
  startTime: 0,
  circles: [],
  circleId: 0,
  // Ranking state
  rankingSongIndex: 0,
  rankingDifficulty: 'easy',
  // GIF background state
  currentGifIndex: 0,
  gifInterval: null,
};

// GIF backgrounds for play screen
const PLAY_GIFS = ['ctap2.gif', 'ctap3.gif', 'ctap4.gif', 'ctap5.gif'];

// Volume settings (unified master volume)
let masterVolume = 80;

function loadVolumeSettings() {
  const saved = localStorage.getItem('cybertap_volume_v2');
  if (saved) {
    masterVolume = parseInt(saved) || 80;
  }
  // Update UI
  document.getElementById('master-volume').value = masterVolume;
  document.getElementById('volume-value').textContent = masterVolume + '%';
}

function saveVolumeSettings() {
  localStorage.setItem('cybertap_volume_v2', masterVolume.toString());
}

function updateVolume(value) {
  masterVolume = parseInt(value);
  document.getElementById('volume-value').textContent = masterVolume + '%';
  saveVolumeSettings();
  applyVolume();
}

function applyVolume() {
  const vol = masterVolume / 100;
  // Apply to title BGM
  if (titleBGM) {
    titleBGM.volume = vol;
  }
  // Apply to game BGM
  if (gameBGM) {
    gameBGM.volume = vol;
  }
}

function getVolume() {
  return masterVolume / 100;
}

// Play sound effect with master volume
function playSE(audioElement) {
  if (audioElement) {
    audioElement.volume = getVolume();
    audioElement.currentTime = 0;
    audioElement.play().catch(() => {});
  }
}

// ============================================================
// BGM CONTROL
// ============================================================
let titleBGM = null;
let gameBGM = null;

function initBGM() {
  titleBGM = new Audio('taitoru.mp3');
  titleBGM.loop = true;
  titleBGM.volume = getVolume();
}

function playTitleBGM() {
  if (!titleBGM) initBGM();
  if (gameBGM) {
    gameBGM.pause();
    gameBGM.currentTime = 0;
  }
  titleBGM.volume = getVolume();
  titleBGM.play().catch(() => {});
}

function stopTitleBGM() {
  if (titleBGM) {
    fadeOutAudio(titleBGM, 500);
  }
}

function playGameBGM(audioFile) {
  if (!audioFile) return;
  gameBGM = new Audio(audioFile);
  gameBGM.volume = getVolume();
  gameBGM.play().catch(() => {});
}

function stopGameBGM() {
  if (gameBGM) {
    fadeOutAudio(gameBGM, 300);
  }
}

function fadeOutAudio(audio, duration) {
  const startVolume = audio.volume;
  const steps = 20;
  const stepTime = duration / steps;
  const volumeStep = startVolume / steps;

  let currentStep = 0;
  const fadeInterval = setInterval(() => {
    currentStep++;
    audio.volume = Math.max(0, startVolume - (volumeStep * currentStep));
    if (currentStep >= steps) {
      clearInterval(fadeInterval);
      audio.pause();
      audio.currentTime = 0;
      audio.volume = startVolume;
    }
  }, stepTime);
}

function fadeInAudio(audio, duration, targetVolume) {
  audio.volume = 0;
  audio.play().catch(() => {});

  const steps = 20;
  const stepTime = duration / steps;
  const volumeStep = targetVolume / steps;

  let currentStep = 0;
  const fadeInterval = setInterval(() => {
    currentStep++;
    audio.volume = Math.min(targetVolume, volumeStep * currentStep);
    if (currentStep >= steps) {
      clearInterval(fadeInterval);
    }
  }, stepTime);
}

// ============================================================
// SCREEN MANAGEMENT WITH FADE
// ============================================================
function showScreen(screenId, withFade = false) {
  if (withFade) {
    const fade = document.getElementById('screen-fade');
    fade.classList.add('active');

    setTimeout(() => {
      doScreenSwitch(screenId);
      setTimeout(() => {
        fade.classList.remove('active');
      }, 100);
    }, 400);
  } else {
    doScreenSwitch(screenId);
  }
}

function doScreenSwitch(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
  gameState.currentScreen = screenId;

  if (screenId === 'song-select') {
    renderSongList();
  } else if (screenId === 'ranking') {
    renderRanking();
  } else if (screenId === 'title-screen') {
    playTitleBGM();
    // Re-trigger animations when returning to title screen
    const titleScreen = document.getElementById('title-screen');
    titleScreen.classList.remove('animate');
    // Force reflow to restart animations
    void titleScreen.offsetWidth;
    titleScreen.classList.add('animate');
  }
}

// ============================================================
// SONG LIST
// ============================================================
function renderSongList() {
  const container = document.getElementById('song-list');
  container.innerHTML = '';

  SONGS.forEach(song => {
    const item = document.createElement('div');
    item.className = 'song-item';
    item.innerHTML = `
      <div class="song-title">${song.title}</div>
      <div class="song-artist">${song.artist}</div>
      <div class="song-bpm">BPM ${song.bpm}</div>
    `;
    item.onclick = () => selectSong(song);
    container.appendChild(item);
  });
}

function selectSong(song) {
  gameState.selectedSong = song;
  document.getElementById('selected-song-name').textContent = song.title;
  showScreen('difficulty-select');
}

// ============================================================
// GAME START
// ============================================================
function startGame(difficulty) {
  // Stop title BGM with fade
  stopTitleBGM();

  // Hide static background, show GIF only
  document.body.classList.add('playing');

  gameState.selectedDifficulty = difficulty;
  gameState.score = 0;
  gameState.combo = 0;
  gameState.maxCombo = 0;
  gameState.hits = { perfect: 0, great: 0, good: 0, miss: 0 };
  gameState.circles = [];
  gameState.circleId = 0;

  document.getElementById('play-song-name').textContent = gameState.selectedSong.title;
  document.getElementById('play-difficulty').textContent = difficulty.toUpperCase();
  document.getElementById('current-score').textContent = '0';
  document.getElementById('current-combo').textContent = '';
  document.getElementById('progress-fill').style.width = '0%';
  document.getElementById('play-area').innerHTML = '';

  // Start GIF background rotation
  startGifBackground();

  // Show play screen with fade
  showScreen('play-screen', true);

  // Wait for fade, then countdown
  setTimeout(() => {
    countdown(3, () => {
      gameState.isPlaying = true;
      gameState.startTime = Date.now();
      generateCircles();
      gameLoop();
    });
  }, 600);
}

// GIF background rotation
function startGifBackground() {
  const playBg = document.getElementById('play-bg');
  gameState.currentGifIndex = 0;
  playBg.style.backgroundImage = `url('${PLAY_GIFS[0]}')`;

  // Clear any existing interval
  if (gameState.gifInterval) {
    clearInterval(gameState.gifInterval);
  }

  // Rotate GIFs every 3 seconds
  gameState.gifInterval = setInterval(() => {
    gameState.currentGifIndex = (gameState.currentGifIndex + 1) % PLAY_GIFS.length;
    playBg.style.backgroundImage = `url('${PLAY_GIFS[gameState.currentGifIndex]}')`;
  }, 3000);
}

function stopGifBackground() {
  if (gameState.gifInterval) {
    clearInterval(gameState.gifInterval);
    gameState.gifInterval = null;
  }
}

function countdown(count, callback) {
  const area = document.getElementById('play-area');

  if (count <= 0) {
    // Show GO!
    const goEl = document.createElement('div');
    goEl.className = 'countdown go';
    goEl.textContent = 'GO!';
    area.appendChild(goEl);

    // Start game BGM
    if (gameState.selectedSong.audioFile) {
      playGameBGM(gameState.selectedSong.audioFile);
    }

    setTimeout(() => {
      goEl.remove();
      callback();
    }, 800);
    return;
  }

  const countEl = document.createElement('div');
  countEl.className = 'countdown';
  countEl.textContent = count;
  area.appendChild(countEl);

  setTimeout(() => {
    countEl.remove();
    countdown(count - 1, callback);
  }, 900);
}

// ============================================================
// CIRCLE GENERATION - With 3 sizes
// Notes arrive in number order with minimum interval
// ============================================================
function generateCircles() {
  const song = gameState.selectedSong;
  const difficulty = gameState.selectedDifficulty;

  // Circles per second based on difficulty
  const circlesPerSecond = { easy: 1.2, normal: 2, hard: 3 }[difficulty];

  // Size distribution: medium (normal), large (strong beats), xlarge (accents)
  const sizeDistribution = {
    easy:   { medium: 0.75, large: 0.22, xlarge: 0.03 },
    normal: { medium: 0.65, large: 0.30, xlarge: 0.05 },
    hard:   { medium: 0.55, large: 0.38, xlarge: 0.07 },
  }[difficulty];

  const totalCircles = Math.floor(song.duration * circlesPerSecond);

  const area = document.getElementById('play-area');
  const areaRect = area.getBoundingClientRect();
  const padding = 80;

  // Minimum interval between hitTimes (no simultaneous taps)
  const minHitInterval = 300; // 0.3 seconds minimum

  // Calculate hitTime interval (ensuring minimum interval)
  const rawInterval = (song.duration * 1000) / totalCircles;
  const hitInterval = Math.max(rawInterval, minHitInterval);

  // First hitTime starts after the longest approach time to ensure all notes can appear
  const maxApproachTime = Math.max(
    CIRCLE_TYPES.medium.approachTime,
    CIRCLE_TYPES.large.approachTime,
    CIRCLE_TYPES.xlarge.approachTime
  );
  const firstHitTime = maxApproachTime + 500; // Start 0.5s after max approach time

  for (let i = 0; i < totalCircles; i++) {
    // Determine circle size (medium, large, xlarge)
    const rand = Math.random();
    let circleType;
    if (rand < sizeDistribution.medium) {
      circleType = 'medium';
    } else if (rand < sizeDistribution.medium + sizeDistribution.large) {
      circleType = 'large';
    } else {
      circleType = 'xlarge';
    }

    const typeConfig = CIRCLE_TYPES[circleType];

    // HitTime is sequential (notes arrive in number order)
    const hitTime = firstHitTime + (i * hitInterval);

    // AppearTime is calculated backwards from hitTime
    const appearTime = hitTime - typeConfig.approachTime;

    // Random position within play area
    const maxX = Math.max(100, areaRect.width - padding * 2);
    const maxY = Math.max(100, areaRect.height - padding * 2);

    gameState.circles.push({
      id: gameState.circleId++,
      type: circleType,
      appearTime,
      hitTime,
      x: padding + Math.random() * maxX,
      y: padding + Math.random() * maxY,
      number: i + 1,
      active: false,
      hit: false,
    });
  }
}

// ============================================================
// GAME LOOP
// ============================================================
function gameLoop() {
  if (!gameState.isPlaying) return;

  const elapsed = Date.now() - gameState.startTime;
  const song = gameState.selectedSong;
  const duration = song.duration * 1000;

  // Update progress bar
  const progress = Math.min(100, (elapsed / duration) * 100);
  document.getElementById('progress-fill').style.width = progress + '%';

  // Check for circles to appear
  gameState.circles.forEach(circle => {
    if (!circle.active && !circle.hit && elapsed >= circle.appearTime) {
      circle.active = true;
      spawnCircle(circle);
    }

    // Check for missed circles
    if (circle.active && !circle.hit) {
      const typeConfig = CIRCLE_TYPES[circle.type];
      if (elapsed > circle.hitTime + typeConfig.missWindow) {
        circle.hit = true;
        removeCircle(circle.id);
        registerHit('miss', circle.x, circle.y, circle.type);
      }
    }
  });

  // End game check
  if (elapsed >= duration + 500) {
    endGame();
    return;
  }

  requestAnimationFrame(gameLoop);
}

function spawnCircle(circle) {
  const area = document.getElementById('play-area');
  const areaRect = area.getBoundingClientRect();
  const typeConfig = CIRCLE_TYPES[circle.type];

  // Ensure circle is within bounds
  const halfSize = typeConfig.size / 2;
  const x = Math.min(Math.max(halfSize + 10, circle.x), areaRect.width - halfSize - 10);
  const y = Math.min(Math.max(halfSize + 10, circle.y), areaRect.height - halfSize - 10);

  const el = document.createElement('div');
  el.className = `hit-circle ${circle.type}`;
  el.id = 'circle-' + circle.id;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.innerHTML = `<div class="approach-ring"></div><span>${circle.number}</span>`;

  const hitHandler = (e) => {
    e.preventDefault();
    e.stopPropagation();
    hitCircle(circle);
  };

  el.addEventListener('click', hitHandler);
  el.addEventListener('touchstart', hitHandler, { passive: false });

  area.appendChild(el);
}

function removeCircle(id) {
  const el = document.getElementById('circle-' + id);
  if (el) el.remove();
}

// ============================================================
// HIT DETECTION
// ============================================================
function hitCircle(circle) {
  if (circle.hit) return;
  circle.hit = true;

  const elapsed = Date.now() - gameState.startTime;
  const timing = Math.abs(elapsed - circle.hitTime);
  const typeConfig = CIRCLE_TYPES[circle.type];

  let result;
  let scoreGained = 0;

  if (timing < typeConfig.timingWindow.perfect) {
    result = 'perfect';
    scoreGained = Math.floor(BASE_SCORES.perfect * typeConfig.scoreMultiplier);
  } else if (timing < typeConfig.timingWindow.great) {
    result = 'great';
    scoreGained = Math.floor(BASE_SCORES.great * typeConfig.scoreMultiplier);
  } else if (timing < typeConfig.timingWindow.good) {
    result = 'good';
    scoreGained = Math.floor(BASE_SCORES.good * typeConfig.scoreMultiplier);
  } else {
    result = 'miss';
  }

  if (result !== 'miss') {
    gameState.score += scoreGained;
  }

  const el = document.getElementById('circle-' + circle.id);
  let feedbackX = circle.x, feedbackY = circle.y;
  if (el) {
    const rect = el.getBoundingClientRect();
    const area = document.getElementById('play-area').getBoundingClientRect();
    feedbackX = rect.left - area.left + rect.width / 2;
    feedbackY = rect.top - area.top + rect.height / 2;
  }

  removeCircle(circle.id);
  registerHit(result, feedbackX, feedbackY, circle.type, scoreGained);
}

function registerHit(result, x, y, circleType, scoreGained = 0) {
  gameState.hits[result]++;

  if (result === 'miss') {
    gameState.combo = 0;
  } else {
    gameState.combo++;
    if (gameState.combo > gameState.maxCombo) {
      gameState.maxCombo = gameState.combo;
    }
  }

  document.getElementById('current-score').textContent = gameState.score.toLocaleString();
  document.getElementById('current-combo').textContent =
    gameState.combo > 1 ? `${gameState.combo} COMBO` : '';

  showFeedback(result, x, y, scoreGained);
  spawnTapEffects(result, x, y, circleType);
}

function showFeedback(result, x, y, score = 0) {
  const area = document.getElementById('play-area');
  const feedback = document.createElement('div');
  feedback.className = 'hit-feedback ' + result;
  feedback.textContent = result === 'miss' ? 'MISS' : `${result.toUpperCase()} +${score}`;
  feedback.style.left = x + 'px';
  feedback.style.top = y + 'px';
  area.appendChild(feedback);

  setTimeout(() => feedback.remove(), 500);
}

// ============================================================
// TAP EFFECTS - Ripple, Flash, Particles
// ============================================================
function spawnTapEffects(result, x, y, circleType) {
  if (result === 'miss') return;

  const area = document.getElementById('play-area');
  const isPerfect = result === 'perfect';
  const typeConfig = CIRCLE_TYPES[circleType];

  // Create ripple effect
  const ripple = document.createElement('div');
  ripple.className = 'tap-ripple';
  if (isPerfect) ripple.classList.add('perfect');

  // Size-based effects
  if (circleType === 'large') {
    ripple.classList.add('large-effect');
  } else if (circleType === 'xlarge') {
    ripple.classList.add('xlarge-effect');
  }

  ripple.style.left = x + 'px';
  ripple.style.top = y + 'px';
  area.appendChild(ripple);
  setTimeout(() => ripple.remove(), 800);

  // For large circles: add glow pulse
  if (circleType === 'large') {
    const glow = document.createElement('div');
    glow.className = 'tap-ripple';
    if (isPerfect) glow.classList.add('perfect');
    glow.style.left = x + 'px';
    glow.style.top = y + 'px';
    glow.style.animationDelay = '0.1s';
    area.appendChild(glow);
    setTimeout(() => glow.remove(), 600);
  }

  // For xlarge circles: screen flash + particles
  if (circleType === 'xlarge') {
    // Screen flash
    const flash = document.createElement('div');
    flash.className = 'screen-flash';
    if (isPerfect) {
      flash.style.background = 'radial-gradient(circle, rgba(0, 255, 136, 0.5) 0%, rgba(0, 212, 255, 0.3) 50%, transparent 70%)';
    }
    document.body.appendChild(flash);
    setTimeout(() => flash.remove(), 300);

    // Spawn particles
    spawnParticles(x, y, isPerfect ? 16 : 10, area);

    // Extra ripple wave for xlarge
    const wave = document.createElement('div');
    wave.className = 'tap-ripple xlarge-effect';
    if (isPerfect) wave.classList.add('perfect');
    wave.style.left = x + 'px';
    wave.style.top = y + 'px';
    wave.style.animationDelay = '0.15s';
    area.appendChild(wave);
    setTimeout(() => wave.remove(), 1000);
  }

  // Perfect bonus: extra mini ripple
  if (isPerfect && circleType !== 'xlarge') {
    const bonusRipple = document.createElement('div');
    bonusRipple.className = 'tap-ripple perfect';
    bonusRipple.style.left = x + 'px';
    bonusRipple.style.top = y + 'px';
    bonusRipple.style.animationDelay = '0.05s';
    area.appendChild(bonusRipple);
    setTimeout(() => bonusRipple.remove(), 600);
  }
}

function spawnParticles(x, y, count, container) {
  const colors = ['var(--neon-primary)', 'var(--neon-pink)', 'var(--neon-secondary)', 'var(--neon-purple)'];

  for (let i = 0; i < count; i++) {
    const particle = document.createElement('div');
    particle.className = 'tap-particle';

    // Random angle for burst direction
    const angle = (Math.PI * 2 * i) / count + (Math.random() * 0.5 - 0.25);
    const distance = 60 + Math.random() * 80;
    const tx = Math.cos(angle) * distance;
    const ty = Math.sin(angle) * distance;

    particle.style.left = x + 'px';
    particle.style.top = y + 'px';
    particle.style.setProperty('--tx', tx + 'px');
    particle.style.setProperty('--ty', ty + 'px');
    particle.style.background = colors[i % colors.length];
    particle.style.boxShadow = `0 0 6px ${colors[i % colors.length]}`;
    particle.style.animationDelay = `${i * 0.02}s`;

    container.appendChild(particle);
    setTimeout(() => particle.remove(), 800);
  }
}

// ============================================================
// GAME END
// ============================================================
function endGame() {
  gameState.isPlaying = false;
  stopGifBackground();
  stopGameBGM();

  // Show static background again on result screen
  document.body.classList.remove('playing');

  const totalNotes = gameState.circles.length;
  const hitNotes = gameState.hits.perfect + gameState.hits.great + gameState.hits.good;
  const accuracy = totalNotes > 0 ? (hitNotes / totalNotes) * 100 : 0;

  let grade, gradeClass;
  if (accuracy >= 95 && gameState.hits.miss === 0) {
    grade = 'S';
    gradeClass = 'grade-s';
  } else if (accuracy >= 85) {
    grade = 'A';
    gradeClass = 'grade-a';
  } else if (accuracy >= 70) {
    grade = 'B';
    gradeClass = 'grade-b';
  } else {
    grade = 'C';
    gradeClass = 'grade-c';
  }

  // Prepare result data before transition
  const resultData = {
    grade,
    gradeClass,
    score: gameState.score.toLocaleString(),
    combo: gameState.maxCombo,
    perfect: gameState.hits.perfect,
    great: gameState.hits.great,
    good: gameState.hits.good,
    miss: gameState.hits.miss
  };

  saveScore();

  // Show result screen with fade
  showScreen('result-screen', true);

  // Apply result data after fade starts
  setTimeout(() => {
    document.getElementById('result-grade').textContent = resultData.grade;
    document.getElementById('result-grade').className = 'result-grade ' + resultData.gradeClass;
    document.getElementById('result-score').textContent = resultData.score;
    document.getElementById('result-combo').textContent = resultData.combo;
    document.getElementById('result-perfect').textContent = resultData.perfect;
    document.getElementById('result-great').textContent = resultData.great;
    document.getElementById('result-good').textContent = resultData.good;
    document.getElementById('result-miss').textContent = resultData.miss;
  }, 300);
}

function retryGame() {
  startGame(gameState.selectedDifficulty);
}

// ============================================================
// RANKING (localStorage)
// ============================================================
function saveScore() {
  const key = `cybertap_ranking_${gameState.selectedSong.id}_${gameState.selectedDifficulty}`;
  let rankings = JSON.parse(localStorage.getItem(key) || '[]');

  rankings.push({
    score: gameState.score,
    combo: gameState.maxCombo,
    date: new Date().toISOString(),
  });

  rankings.sort((a, b) => b.score - a.score);
  rankings = rankings.slice(0, 10);

  localStorage.setItem(key, JSON.stringify(rankings));
}

function renderRanking() {
  const container = document.getElementById('ranking-list');
  const song = SONGS[gameState.rankingSongIndex];
  const diff = gameState.rankingDifficulty;

  // Update title
  document.getElementById('ranking-song-title').textContent = song.title;

  // Update tab active state
  document.querySelectorAll('.ranking-diff-tab').forEach(tab => {
    tab.classList.toggle('active', tab.textContent.toLowerCase() === diff);
  });

  // Get rankings
  const key = `cybertap_ranking_${song.id}_${diff}`;
  const rankings = JSON.parse(localStorage.getItem(key) || '[]');

  container.innerHTML = '';

  if (rankings.length === 0) {
    container.innerHTML = '<div style="color: var(--text-sub); padding: 40px; text-align: center;">No records yet.<br>Play this song!</div>';
    return;
  }

  // Show TOP 10
  rankings.slice(0, 10).forEach((entry, idx) => {
    const item = document.createElement('div');
    item.className = 'ranking-item';

    let rankClass = '';
    if (idx === 0) rankClass = 'gold';
    else if (idx === 1) rankClass = 'silver';
    else if (idx === 2) rankClass = 'bronze';

    item.innerHTML = `
      <div class="rank ${rankClass}">#${idx + 1}</div>
      <div class="info">
        <div class="name">Combo: ${entry.combo}</div>
        <div class="meta">${new Date(entry.date).toLocaleDateString()}</div>
      </div>
      <div class="score">${entry.score.toLocaleString()}</div>
    `;
    container.appendChild(item);
  });
}

function changeRankingSong(direction) {
  gameState.rankingSongIndex = (gameState.rankingSongIndex + direction + SONGS.length) % SONGS.length;
  renderRanking();
}

function changeRankingDiff(diff) {
  gameState.rankingDifficulty = diff;
  renderRanking();
}

// ============================================================
// INIT
// ============================================================
// Check if mobile device
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
         ('ontouchstart' in window) ||
         (navigator.maxTouchPoints > 0);
}

// Initialize audio context (required for mobile)
function initAudioContext() {
  // Create a silent audio context to unlock audio on mobile
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  if (AudioContext) {
    const ctx = new AudioContext();
    // Create a short silent buffer and play it
    const buffer = ctx.createBuffer(1, 1, 22050);
    const source = ctx.createBufferSource();
    source.buffer = buffer;
    source.connect(ctx.destination);
    source.start(0);
    // Resume context if suspended
    if (ctx.state === 'suspended') {
      ctx.resume();
    }
  }
}

document.addEventListener('DOMContentLoaded', () => {
  document.addEventListener('touchmove', e => {
    if (gameState.isPlaying) e.preventDefault();
  }, { passive: false });

  // Load volume settings
  loadVolumeSettings();

  // Initialize BGM
  initBGM();

  // Always show TAP TO START screen (for both PC and mobile)
  // This ensures audio is properly initialized after user interaction
  const tapScreen = document.getElementById('tap-start-screen');
  tapScreen.classList.add('show');

  const handleTap = () => {
    // Initialize audio context (required for all browsers)
    initAudioContext();
    // Start title BGM
    playTitleBGM();
    // Hide tap screen
    tapScreen.classList.remove('show');
    // Start title screen animations
    const titleScreen = document.getElementById('title-screen');
    titleScreen.classList.add('animate');
    // Remove listeners
    tapScreen.removeEventListener('click', handleTap);
    tapScreen.removeEventListener('touchstart', handleTap);
  };

  tapScreen.addEventListener('click', handleTap);
  tapScreen.addEventListener('touchstart', handleTap, { passive: true });
});
</script>

</body>
</html>
