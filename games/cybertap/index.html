<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CyberTap | eye-factory</title>
<link rel="icon" type="image/png" href="favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #0a0a0f;
  --bg-card: rgba(15, 15, 25, 0.9);
  --text: #e0e0e0;
  --text-sub: #8a8a9a;
  --neon-primary: #00d4ff;
  --neon-secondary: #00ff88;
  --neon-pink: #ff00aa;
  --neon-purple: #8b5cf6;
  --neon-yellow: #ffdd00;
  --neon-orange: #ff8800;
  --font-en: 'Orbitron', sans-serif;
  --font-ja: 'Noto Sans JP', sans-serif;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  touch-action: manipulation;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}

body {
  font-family: var(--font-ja);
  background: var(--bg);
  color: var(--text);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Background image - lowest layer */
.bg-image {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: url('ctap1.png') center center / cover no-repeat;
  opacity: 0.18;
  pointer-events: none;
  z-index: -2;
}

/* Cyber noise overlay */
.bg-noise {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: -1;
  opacity: 0;
  background: repeating-linear-gradient(
    0deg,
    rgba(0, 212, 255, 0.03) 0px,
    rgba(0, 212, 255, 0.03) 1px,
    transparent 1px,
    transparent 2px
  );
  animation: cyberGlitch 4s infinite;
}

@keyframes cyberGlitch {
  0%, 92%, 94%, 96%, 100% { opacity: 0; }
  92.5% { opacity: 0.8; transform: translateX(2px); }
  93% { opacity: 0; }
  94.5% { opacity: 0.6; transform: translateX(-3px) skewX(1deg); }
  95% { opacity: 0.9; transform: translateX(1px); }
  95.5% { opacity: 0; transform: translateX(0); }
  96.5% { opacity: 0.7; transform: translateY(1px); }
  97% { opacity: 0; transform: translateY(0); }
}

/* Additional scan line effect */
.bg-scanlines {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: -1;
  background: repeating-linear-gradient(
    transparent 0px,
    transparent 3px,
    rgba(0, 0, 0, 0.1) 3px,
    rgba(0, 0, 0, 0.1) 4px
  );
  animation: scanFlicker 8s infinite;
}

@keyframes scanFlicker {
  0%, 89%, 91%, 93%, 95%, 97%, 100% { opacity: 0.3; }
  90% { opacity: 0.5; }
  92% { opacity: 0.2; }
  94% { opacity: 0.6; }
  96% { opacity: 0.4; }
}

/* Background grid */
.bg-grid {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-image:
    linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
  background-size: 50px 50px;
  pointer-events: none;
  z-index: 0;
}

/* Rotate guide for portrait mode */
#rotate-guide {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: var(--bg);
  z-index: 9999;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 40px;
}
#rotate-guide .icon {
  font-size: 80px;
  margin-bottom: 30px;
  animation: rotateHint 2s ease-in-out infinite;
}
@keyframes rotateHint {
  0%, 100% { transform: rotate(0deg); }
  50% { transform: rotate(90deg); }
}
#rotate-guide .message {
  font-family: var(--font-en);
  font-size: 20px;
  color: var(--neon-primary);
  margin-bottom: 10px;
}
#rotate-guide .sub-message {
  font-size: 14px;
  color: var(--text-sub);
}

@media (orientation: portrait) and (max-width: 900px) {
  #rotate-guide { display: flex; }
  #game-container { display: none !important; }
}

/* Game container - Landscape optimized */
#game-container {
  position: relative;
  width: 100%;
  height: 100%;
  max-width: 1200px;
  max-height: 100vh;
  z-index: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Screens */
.screen {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  padding: 20px;
  text-align: center;
  overflow-y: auto;
}
.screen.active { display: flex; }

/* Title screen */
#title-screen .game-title {
  font-family: var(--font-en);
  font-size: clamp(48px, 10vw, 80px);
  font-weight: 900;
  background: linear-gradient(90deg, var(--neon-primary), var(--neon-pink), var(--neon-primary));
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: gradientShift 3s ease-in-out infinite;
  filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.5));
  margin-bottom: 10px;
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

#title-screen .subtitle {
  font-family: var(--font-en);
  font-size: 14px;
  color: var(--text-sub);
  letter-spacing: 0.3em;
  margin-bottom: 40px;
}

.title-buttons {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  justify-content: center;
}

/* Buttons */
.btn {
  font-family: var(--font-en);
  font-size: 16px;
  font-weight: 700;
  padding: 14px 40px;
  border: 2px solid var(--neon-primary);
  background: transparent;
  color: var(--neon-primary);
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}
.btn:hover, .btn:active {
  background: var(--neon-primary);
  color: #000;
  box-shadow: 0 0 20px var(--neon-primary), 0 0 40px var(--neon-primary);
}
.btn.secondary {
  border-color: var(--neon-pink);
  color: var(--neon-pink);
}
.btn.secondary:hover, .btn.secondary:active {
  background: var(--neon-pink);
  color: #000;
  box-shadow: 0 0 20px var(--neon-pink);
}
.btn.small {
  font-size: 12px;
  padding: 10px 24px;
}

/* Song select - Horizontal layout */
#song-select {
  flex-direction: row;
  padding: 20px 40px;
  gap: 30px;
}
.song-select-left {
  flex: 0 0 auto;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
#song-select .section-title {
  font-family: var(--font-en);
  font-size: 28px;
  font-weight: 700;
  color: var(--neon-primary);
  margin-bottom: 20px;
  text-shadow: 0 0 10px var(--neon-primary);
}

.song-list {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  max-height: 80vh;
  overflow-y: auto;
  padding: 10px;
  align-content: start;
}

.song-item {
  background: var(--bg-card);
  border: 1px solid rgba(0, 212, 255, 0.3);
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: left;
}
.song-item:hover, .song-item.selected {
  border-color: var(--neon-primary);
  box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
  transform: scale(1.02);
}
.song-item .song-title {
  font-family: var(--font-en);
  font-size: 16px;
  font-weight: 700;
  color: var(--neon-primary);
  margin-bottom: 4px;
}
.song-item .song-artist {
  font-size: 12px;
  color: var(--text-sub);
}
.song-item .song-bpm {
  font-family: var(--font-en);
  font-size: 11px;
  color: var(--neon-pink);
  margin-top: 6px;
}

/* Difficulty select - Horizontal layout */
#difficulty-select {
  flex-direction: row;
  gap: 40px;
}
.difficulty-info {
  text-align: center;
}
.difficulty-buttons {
  display: flex;
  flex-direction: row;
  gap: 20px;
  flex-wrap: wrap;
  justify-content: center;
}
.diff-btn {
  font-family: var(--font-en);
  font-size: 18px;
  font-weight: 700;
  padding: 20px 40px;
  border: 2px solid;
  background: transparent;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  min-width: 140px;
}
.diff-btn.easy {
  border-color: var(--neon-secondary);
  color: var(--neon-secondary);
}
.diff-btn.easy:hover {
  background: var(--neon-secondary);
  color: #000;
  box-shadow: 0 0 20px var(--neon-secondary);
}
.diff-btn.normal {
  border-color: var(--neon-yellow);
  color: var(--neon-yellow);
}
.diff-btn.normal:hover {
  background: var(--neon-yellow);
  color: #000;
  box-shadow: 0 0 20px var(--neon-yellow);
}
.diff-btn.hard {
  border-color: var(--neon-pink);
  color: var(--neon-pink);
}
.diff-btn.hard:hover {
  background: var(--neon-pink);
  color: #000;
  box-shadow: 0 0 20px var(--neon-pink);
}

.selected-song-info {
  font-size: 14px;
  color: var(--text-sub);
  margin-bottom: 20px;
}
.selected-song-info strong {
  color: var(--neon-primary);
  font-family: var(--font-en);
  font-size: 24px;
}

/* Play screen */
#play-screen {
  position: relative;
  padding: 0;
  overflow: hidden;
  background: rgba(0, 0, 0, 0.5);
}

/* Play screen GIF background */
#play-bg {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-size: cover;
  background-position: center;
  opacity: 0.09;
  z-index: 0;
  pointer-events: none;
}

#play-area {
  position: absolute;
  top: 60px; left: 0; right: 0; bottom: 30px;
  overflow: hidden;
}

.play-hud {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 60px;
  padding: 10px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0.5));
  z-index: 10;
}
.play-hud .score {
  font-family: var(--font-en);
  font-size: 28px;
  font-weight: 700;
  color: var(--neon-primary);
  text-shadow: 0 0 10px var(--neon-primary);
}
.play-hud .combo {
  font-family: var(--font-en);
  font-size: 16px;
  color: var(--neon-secondary);
}
.play-hud .song-info {
  font-size: 12px;
  color: var(--text-sub);
  text-align: right;
}
.play-hud .song-info .song-name {
  font-family: var(--font-en);
  color: var(--neon-primary);
}

/* Hit circles - 3 sizes */
.hit-circle {
  position: absolute;
  border-radius: 50%;
  border: 3px solid var(--neon-primary);
  background: rgba(0, 212, 255, 0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-en);
  font-weight: 700;
  color: var(--neon-primary);
  cursor: pointer;
  box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
  animation: circleAppear 0.2s ease-out;
  transform: translate(-50%, -50%);
}
.hit-circle:active {
  transform: translate(-50%, -50%) scale(0.95);
}

/* Small circle - Fast, high score */
.hit-circle.small {
  width: 50px;
  height: 50px;
  font-size: 14px;
  border-color: var(--neon-orange);
  background: rgba(255, 136, 0, 0.15);
  color: var(--neon-orange);
  box-shadow: 0 0 15px rgba(255, 136, 0, 0.5);
}
.hit-circle.small .approach-ring {
  border-color: var(--neon-orange);
}

/* Medium circle - Normal */
.hit-circle.medium {
  width: 70px;
  height: 70px;
  font-size: 18px;
}

/* Large circle - Slow, low score */
.hit-circle.large {
  width: 100px;
  height: 100px;
  font-size: 24px;
  border-color: var(--neon-purple);
  background: rgba(139, 92, 246, 0.15);
  color: var(--neon-purple);
  box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
}
.hit-circle.large .approach-ring {
  border-color: var(--neon-purple);
}

.hit-circle .approach-ring {
  position: absolute;
  border: 2px solid var(--neon-primary);
  border-radius: 50%;
  opacity: 0.7;
  pointer-events: none;
}

/* Approach ring animations for each size */
.hit-circle.small .approach-ring {
  width: 100px; height: 100px;
  animation: approachSmall 0.6s linear forwards;
}
.hit-circle.medium .approach-ring {
  width: 140px; height: 140px;
  animation: approachMedium 1s linear forwards;
}
.hit-circle.large .approach-ring {
  width: 200px; height: 200px;
  animation: approachLarge 1.5s linear forwards;
}

@keyframes circleAppear {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes approachSmall {
  from { width: 100px; height: 100px; opacity: 0.8; }
  to { width: 50px; height: 50px; opacity: 0; }
}
@keyframes approachMedium {
  from { width: 140px; height: 140px; opacity: 0.8; }
  to { width: 70px; height: 70px; opacity: 0; }
}
@keyframes approachLarge {
  from { width: 200px; height: 200px; opacity: 0.8; }
  to { width: 100px; height: 100px; opacity: 0; }
}

/* Hit feedback */
.hit-feedback {
  position: absolute;
  font-family: var(--font-en);
  font-size: 18px;
  font-weight: 700;
  animation: feedbackPop 0.5s ease-out forwards;
  pointer-events: none;
  transform: translate(-50%, -50%);
  white-space: nowrap;
}
.hit-feedback.perfect {
  color: var(--neon-secondary);
  text-shadow: 0 0 10px var(--neon-secondary);
}
.hit-feedback.great {
  color: var(--neon-primary);
  text-shadow: 0 0 10px var(--neon-primary);
}
.hit-feedback.good {
  color: var(--neon-yellow);
  text-shadow: 0 0 10px var(--neon-yellow);
}
.hit-feedback.miss {
  color: var(--neon-pink);
  text-shadow: 0 0 10px var(--neon-pink);
}

@keyframes feedbackPop {
  0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  100% { transform: translate(-50%, calc(-50% - 30px)) scale(1.2); opacity: 0; }
}

/* Result screen - Horizontal layout */
#result-screen {
  flex-direction: row;
  gap: 40px;
  padding: 30px;
}
.result-left {
  display: flex;
  flex-direction: column;
  align-items: center;
}
#result-screen .result-title {
  font-family: var(--font-en);
  font-size: 32px;
  font-weight: 900;
  color: var(--neon-primary);
  margin-bottom: 20px;
  text-shadow: 0 0 20px var(--neon-primary);
}

.result-grade {
  font-family: var(--font-en);
  font-size: 80px;
  font-weight: 900;
  text-shadow: 0 0 30px currentColor;
  line-height: 1;
}
.grade-s { color: var(--neon-secondary); }
.grade-a { color: var(--neon-primary); }
.grade-b { color: var(--neon-yellow); }
.grade-c { color: var(--neon-pink); }

.result-stats {
  background: var(--bg-card);
  border: 1px solid rgba(0, 212, 255, 0.3);
  border-radius: 16px;
  padding: 24px;
  min-width: 260px;
}
.result-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.result-row:last-child { border-bottom: none; }
.result-row .label {
  color: var(--text-sub);
  font-size: 14px;
}
.result-row .value {
  font-family: var(--font-en);
  font-weight: 700;
}
.result-row .value.score {
  font-size: 24px;
  color: var(--neon-primary);
}
.result-row .value.perfect { color: var(--neon-secondary); }
.result-row .value.great { color: var(--neon-primary); }
.result-row .value.good { color: var(--neon-yellow); }
.result-row .value.miss { color: var(--neon-pink); }

.result-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 20px;
}

/* Ranking screen */
#ranking-screen {
  padding: 20px 40px;
  flex-direction: column;
}
.ranking-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  margin-bottom: 10px;
}
.ranking-nav-btn {
  font-family: var(--font-en);
  font-size: 24px;
  width: 40px;
  height: 40px;
  border: 2px solid var(--neon-primary);
  background: transparent;
  color: var(--neon-primary);
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s ease;
}
.ranking-nav-btn:hover {
  background: var(--neon-primary);
  color: #000;
}
.ranking-song-title {
  font-family: var(--font-en);
  font-size: 20px;
  font-weight: 700;
  color: var(--neon-primary);
  min-width: 200px;
  text-align: center;
}
.ranking-diff-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}
.ranking-diff-tab {
  font-family: var(--font-en);
  font-size: 12px;
  padding: 6px 16px;
  border: 1px solid var(--text-sub);
  background: transparent;
  color: var(--text-sub);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
}
.ranking-diff-tab.active {
  border-color: var(--neon-primary);
  color: var(--neon-primary);
  background: rgba(0, 212, 255, 0.1);
}
.ranking-list {
  width: 100%;
  max-width: 500px;
  max-height: 60vh;
  overflow-y: auto;
  margin: 0 auto;
}
.ranking-item {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  background: var(--bg-card);
  border-radius: 8px;
  margin-bottom: 6px;
}
.ranking-item .rank {
  font-family: var(--font-en);
  font-size: 18px;
  font-weight: 700;
  width: 36px;
  color: var(--neon-primary);
}
.ranking-item .rank.gold { color: #ffd700; }
.ranking-item .rank.silver { color: #c0c0c0; }
.ranking-item .rank.bronze { color: #cd7f32; }
.ranking-item .info {
  flex: 1;
  text-align: left;
}
.ranking-item .info .name {
  font-size: 13px;
}
.ranking-item .info .meta {
  font-size: 10px;
  color: var(--text-sub);
}
.ranking-item .score {
  font-family: var(--font-en);
  font-weight: 700;
  color: var(--neon-primary);
}

/* Countdown */
.countdown {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-family: var(--font-en);
  font-size: 100px;
  font-weight: 900;
  color: var(--neon-primary);
  text-shadow: 0 0 40px var(--neon-primary);
  animation: countdownPulse 1s ease-in-out;
  z-index: 20;
}

@keyframes countdownPulse {
  0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
  50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
}

/* Progress bar */
.progress-bar {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 6px;
  background: rgba(255,255,255,0.1);
}
.progress-bar .fill {
  height: 100%;
  background: linear-gradient(90deg, var(--neon-primary), var(--neon-pink));
  transition: width 0.1s linear;
}

/* Back button */
.back-btn {
  position: absolute;
  top: 15px;
  left: 15px;
  font-family: var(--font-en);
  font-size: 12px;
  padding: 8px 16px;
  border: 1px solid var(--text-sub);
  background: rgba(0,0,0,0.5);
  color: var(--text-sub);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 10;
}
.back-btn:hover {
  border-color: var(--neon-primary);
  color: var(--neon-primary);
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
::-webkit-scrollbar-thumb { background: var(--neon-primary); border-radius: 3px; }

/* No audio warning */
.no-audio-warning {
  background: rgba(255, 0, 170, 0.2);
  border: 1px solid var(--neon-pink);
  border-radius: 8px;
  padding: 10px 16px;
  margin-bottom: 15px;
  font-size: 11px;
  color: var(--neon-pink);
}

/* Mobile landscape adjustments */
@media (max-height: 500px) {
  .play-hud { height: 50px; padding: 8px 15px; }
  .play-hud .score { font-size: 22px; }
  #play-area { top: 50px; bottom: 25px; }
  .countdown { font-size: 80px; }
  .result-grade { font-size: 60px; }
  #result-screen { gap: 20px; padding: 15px; }
  .result-stats { padding: 16px; }
}
</style>
</head>
<body>

<div class="bg-image"></div>
<div class="bg-noise"></div>
<div class="bg-scanlines"></div>
<div class="bg-grid"></div>

<!-- Rotate guide for portrait mode -->
<div id="rotate-guide">
  <div class="icon">üì±</div>
  <div class="message">Please Rotate Your Device</div>
  <div class="sub-message">Ê®™ÁîªÈù¢„Åß„Éó„É¨„Ç§„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
</div>

<div id="game-container">
  <!-- Title Screen -->
  <div id="title-screen" class="screen active">
    <h1 class="game-title">CyberTap</h1>
    <p class="subtitle">Rhythm Action Game</p>
    <div class="title-buttons">
      <button class="btn" onclick="showScreen('song-select')">Start</button>
      <button class="btn secondary" onclick="showScreen('ranking')">Ranking</button>
    </div>
  </div>

  <!-- Song Select Screen -->
  <div id="song-select" class="screen">
    <button class="back-btn" onclick="showScreen('title-screen')">Back</button>
    <div class="song-select-left">
      <h2 class="section-title">Select Song</h2>
      <div class="no-audio-warning">BGM not available yet (Tap test mode)</div>
    </div>
    <div class="song-list" id="song-list"></div>
  </div>

  <!-- Difficulty Select Screen -->
  <div id="difficulty-select" class="screen">
    <button class="back-btn" onclick="showScreen('song-select')">Back</button>
    <div class="difficulty-info">
      <h2 class="section-title">Select Difficulty</h2>
      <div class="selected-song-info">
        <strong id="selected-song-name"></strong>
      </div>
    </div>
    <div class="difficulty-buttons">
      <button class="diff-btn easy" onclick="startGame('easy')">Easy</button>
      <button class="diff-btn normal" onclick="startGame('normal')">Normal</button>
      <button class="diff-btn hard" onclick="startGame('hard')">Hard</button>
    </div>
  </div>

  <!-- Play Screen -->
  <div id="play-screen" class="screen">
    <div id="play-bg"></div>
    <div class="play-hud">
      <div>
        <div class="score" id="current-score">0</div>
        <div class="combo" id="current-combo"></div>
      </div>
      <div class="song-info">
        <div class="song-name" id="play-song-name"></div>
        <div id="play-difficulty"></div>
      </div>
    </div>
    <div id="play-area"></div>
    <div class="progress-bar">
      <div class="fill" id="progress-fill"></div>
    </div>
  </div>

  <!-- Result Screen -->
  <div id="result-screen" class="screen">
    <div class="result-left">
      <h2 class="result-title">Result</h2>
      <div class="result-grade" id="result-grade">S</div>
      <div class="result-buttons">
        <button class="btn" onclick="retryGame()">Retry</button>
        <button class="btn secondary" onclick="showScreen('title-screen')">Title</button>
      </div>
    </div>
    <div class="result-stats">
      <div class="result-row">
        <span class="label">Score</span>
        <span class="value score" id="result-score">0</span>
      </div>
      <div class="result-row">
        <span class="label">Max Combo</span>
        <span class="value" id="result-combo">0</span>
      </div>
      <div class="result-row">
        <span class="label">Perfect</span>
        <span class="value perfect" id="result-perfect">0</span>
      </div>
      <div class="result-row">
        <span class="label">Great</span>
        <span class="value great" id="result-great">0</span>
      </div>
      <div class="result-row">
        <span class="label">Good</span>
        <span class="value good" id="result-good">0</span>
      </div>
      <div class="result-row">
        <span class="label">Miss</span>
        <span class="value miss" id="result-miss">0</span>
      </div>
    </div>
  </div>

  <!-- Ranking Screen -->
  <div id="ranking-screen" class="screen">
    <button class="back-btn" onclick="showScreen('title-screen')">Home</button>
    <h2 class="section-title">Ranking</h2>
    <div class="ranking-header">
      <button class="ranking-nav-btn" onclick="changeRankingSong(-1)">&lt;</button>
      <span class="ranking-song-title" id="ranking-song-title">Cyber Rush</span>
      <button class="ranking-nav-btn" onclick="changeRankingSong(1)">&gt;</button>
    </div>
    <div class="ranking-diff-tabs">
      <button class="ranking-diff-tab active" onclick="changeRankingDiff('easy')">Easy</button>
      <button class="ranking-diff-tab" onclick="changeRankingDiff('normal')">Normal</button>
      <button class="ranking-diff-tab" onclick="changeRankingDiff('hard')">Hard</button>
    </div>
    <div class="ranking-list" id="ranking-list"></div>
  </div>
</div>

<script>
// ============================================================
// SONG DATA - Easy to add new songs
// ============================================================
const SONGS = [
  {
    id: 'cyber_rush',
    title: 'Cyber Rush',
    artist: 'eye-factory',
    bpm: 140,
    audioFile: null,
    duration: 10,  // Test: 10 seconds
  },
  {
    id: 'neon_drive',
    title: 'Neon Drive',
    artist: 'eye-factory',
    bpm: 128,
    audioFile: null,
    duration: 10,  // Test: 10 seconds
  },
  {
    id: 'digital_pulse',
    title: 'Digital Pulse',
    artist: 'eye-factory',
    bpm: 150,
    audioFile: null,
    duration: 10,  // Test: 10 seconds
  },
  {
    id: 'synth_wave',
    title: 'Synth Wave',
    artist: 'eye-factory',
    bpm: 120,
    audioFile: null,
    duration: 10,  // Test: 10 seconds
  },
];

// Circle sizes configuration
const CIRCLE_TYPES = {
  small: {
    size: 50,
    approachTime: 600,   // Fast approach
    timingWindow: { perfect: 30, great: 60, good: 100 },
    scoreMultiplier: 2.0, // High score
    missWindow: 150,
  },
  medium: {
    size: 70,
    approachTime: 1000,  // Normal approach
    timingWindow: { perfect: 50, great: 100, good: 180 },
    scoreMultiplier: 1.0, // Normal score
    missWindow: 220,
  },
  large: {
    size: 100,
    approachTime: 1500,  // Slow approach
    timingWindow: { perfect: 80, great: 150, good: 250 },
    scoreMultiplier: 0.5, // Low score
    missWindow: 300,
  },
};

// Base scores
const BASE_SCORES = { perfect: 300, great: 200, good: 100 };

// ============================================================
// GAME STATE
// ============================================================
let gameState = {
  currentScreen: 'title-screen',
  selectedSong: null,
  selectedDifficulty: null,
  score: 0,
  combo: 0,
  maxCombo: 0,
  hits: { perfect: 0, great: 0, good: 0, miss: 0 },
  isPlaying: false,
  startTime: 0,
  circles: [],
  circleId: 0,
  // Ranking state
  rankingSongIndex: 0,
  rankingDifficulty: 'easy',
  // GIF background state
  currentGifIndex: 0,
  gifInterval: null,
};

// GIF backgrounds for play screen
const PLAY_GIFS = ['ctap2.gif', 'ctap3.gif', 'ctap4.gif', 'ctap5.gif'];

// ============================================================
// SCREEN MANAGEMENT
// ============================================================
function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
  gameState.currentScreen = screenId;

  if (screenId === 'song-select') {
    renderSongList();
  } else if (screenId === 'ranking') {
    renderRanking();
  }
}

// ============================================================
// SONG LIST
// ============================================================
function renderSongList() {
  const container = document.getElementById('song-list');
  container.innerHTML = '';

  SONGS.forEach(song => {
    const item = document.createElement('div');
    item.className = 'song-item';
    item.innerHTML = `
      <div class="song-title">${song.title}</div>
      <div class="song-artist">${song.artist}</div>
      <div class="song-bpm">BPM ${song.bpm}</div>
    `;
    item.onclick = () => selectSong(song);
    container.appendChild(item);
  });
}

function selectSong(song) {
  gameState.selectedSong = song;
  document.getElementById('selected-song-name').textContent = song.title;
  showScreen('difficulty-select');
}

// ============================================================
// GAME START
// ============================================================
function startGame(difficulty) {
  gameState.selectedDifficulty = difficulty;
  gameState.score = 0;
  gameState.combo = 0;
  gameState.maxCombo = 0;
  gameState.hits = { perfect: 0, great: 0, good: 0, miss: 0 };
  gameState.circles = [];
  gameState.circleId = 0;

  document.getElementById('play-song-name').textContent = gameState.selectedSong.title;
  document.getElementById('play-difficulty').textContent = difficulty.toUpperCase();
  document.getElementById('current-score').textContent = '0';
  document.getElementById('current-combo').textContent = '';
  document.getElementById('progress-fill').style.width = '0%';
  document.getElementById('play-area').innerHTML = '';

  // Start GIF background rotation
  startGifBackground();

  showScreen('play-screen');

  countdown(3, () => {
    gameState.isPlaying = true;
    gameState.startTime = Date.now();
    generateCircles();
    gameLoop();
  });
}

// GIF background rotation
function startGifBackground() {
  const playBg = document.getElementById('play-bg');
  gameState.currentGifIndex = 0;
  playBg.style.backgroundImage = `url('${PLAY_GIFS[0]}')`;

  // Clear any existing interval
  if (gameState.gifInterval) {
    clearInterval(gameState.gifInterval);
  }

  // Rotate GIFs every 3 seconds
  gameState.gifInterval = setInterval(() => {
    gameState.currentGifIndex = (gameState.currentGifIndex + 1) % PLAY_GIFS.length;
    playBg.style.backgroundImage = `url('${PLAY_GIFS[gameState.currentGifIndex]}')`;
  }, 3000);
}

function stopGifBackground() {
  if (gameState.gifInterval) {
    clearInterval(gameState.gifInterval);
    gameState.gifInterval = null;
  }
}

function countdown(count, callback) {
  if (count <= 0) {
    callback();
    return;
  }

  const area = document.getElementById('play-area');
  const countEl = document.createElement('div');
  countEl.className = 'countdown';
  countEl.textContent = count;
  area.appendChild(countEl);

  setTimeout(() => {
    countEl.remove();
    countdown(count - 1, callback);
  }, 1000);
}

// ============================================================
// CIRCLE GENERATION - With 3 sizes
// Notes arrive in number order with minimum interval
// ============================================================
function generateCircles() {
  const song = gameState.selectedSong;
  const difficulty = gameState.selectedDifficulty;

  // Circles per second based on difficulty
  const circlesPerSecond = { easy: 1.2, normal: 2, hard: 3 }[difficulty];

  // Size distribution based on difficulty
  const sizeDistribution = {
    easy:   { small: 0.1, medium: 0.6, large: 0.3 },
    normal: { small: 0.25, medium: 0.5, large: 0.25 },
    hard:   { small: 0.4, medium: 0.45, large: 0.15 },
  }[difficulty];

  const totalCircles = Math.floor(song.duration * circlesPerSecond);

  const area = document.getElementById('play-area');
  const areaRect = area.getBoundingClientRect();
  const padding = 60;

  // Minimum interval between hitTimes (no simultaneous taps)
  const minHitInterval = 300; // 0.3 seconds minimum

  // Calculate hitTime interval (ensuring minimum interval)
  const rawInterval = (song.duration * 1000) / totalCircles;
  const hitInterval = Math.max(rawInterval, minHitInterval);

  // First hitTime starts after the longest approach time to ensure all notes can appear
  const maxApproachTime = Math.max(
    CIRCLE_TYPES.small.approachTime,
    CIRCLE_TYPES.medium.approachTime,
    CIRCLE_TYPES.large.approachTime
  );
  const firstHitTime = maxApproachTime + 500; // Start 0.5s after max approach time

  for (let i = 0; i < totalCircles; i++) {
    // Determine circle size
    const rand = Math.random();
    let circleType;
    if (rand < sizeDistribution.small) {
      circleType = 'small';
    } else if (rand < sizeDistribution.small + sizeDistribution.medium) {
      circleType = 'medium';
    } else {
      circleType = 'large';
    }

    const typeConfig = CIRCLE_TYPES[circleType];

    // HitTime is sequential (notes arrive in number order)
    const hitTime = firstHitTime + (i * hitInterval);

    // AppearTime is calculated backwards from hitTime
    const appearTime = hitTime - typeConfig.approachTime;

    // Random position within play area
    const maxX = Math.max(100, areaRect.width - padding * 2);
    const maxY = Math.max(100, areaRect.height - padding * 2);

    gameState.circles.push({
      id: gameState.circleId++,
      type: circleType,
      appearTime,
      hitTime,
      x: padding + Math.random() * maxX,
      y: padding + Math.random() * maxY,
      number: i + 1,
      active: false,
      hit: false,
    });
  }
}

// ============================================================
// GAME LOOP
// ============================================================
function gameLoop() {
  if (!gameState.isPlaying) return;

  const elapsed = Date.now() - gameState.startTime;
  const song = gameState.selectedSong;
  const duration = song.duration * 1000;

  // Update progress bar
  const progress = Math.min(100, (elapsed / duration) * 100);
  document.getElementById('progress-fill').style.width = progress + '%';

  // Check for circles to appear
  gameState.circles.forEach(circle => {
    if (!circle.active && !circle.hit && elapsed >= circle.appearTime) {
      circle.active = true;
      spawnCircle(circle);
    }

    // Check for missed circles
    if (circle.active && !circle.hit) {
      const typeConfig = CIRCLE_TYPES[circle.type];
      if (elapsed > circle.hitTime + typeConfig.missWindow) {
        circle.hit = true;
        removeCircle(circle.id);
        registerHit('miss', circle.x, circle.y, circle.type);
      }
    }
  });

  // End game check
  if (elapsed >= duration + 500) {
    endGame();
    return;
  }

  requestAnimationFrame(gameLoop);
}

function spawnCircle(circle) {
  const area = document.getElementById('play-area');
  const areaRect = area.getBoundingClientRect();
  const typeConfig = CIRCLE_TYPES[circle.type];

  // Ensure circle is within bounds
  const halfSize = typeConfig.size / 2;
  const x = Math.min(Math.max(halfSize + 10, circle.x), areaRect.width - halfSize - 10);
  const y = Math.min(Math.max(halfSize + 10, circle.y), areaRect.height - halfSize - 10);

  const el = document.createElement('div');
  el.className = `hit-circle ${circle.type}`;
  el.id = 'circle-' + circle.id;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.innerHTML = `<div class="approach-ring"></div><span>${circle.number}</span>`;

  const hitHandler = (e) => {
    e.preventDefault();
    e.stopPropagation();
    hitCircle(circle);
  };

  el.addEventListener('click', hitHandler);
  el.addEventListener('touchstart', hitHandler, { passive: false });

  area.appendChild(el);
}

function removeCircle(id) {
  const el = document.getElementById('circle-' + id);
  if (el) el.remove();
}

// ============================================================
// HIT DETECTION
// ============================================================
function hitCircle(circle) {
  if (circle.hit) return;
  circle.hit = true;

  const elapsed = Date.now() - gameState.startTime;
  const timing = Math.abs(elapsed - circle.hitTime);
  const typeConfig = CIRCLE_TYPES[circle.type];

  let result;
  let scoreGained = 0;

  if (timing < typeConfig.timingWindow.perfect) {
    result = 'perfect';
    scoreGained = Math.floor(BASE_SCORES.perfect * typeConfig.scoreMultiplier);
  } else if (timing < typeConfig.timingWindow.great) {
    result = 'great';
    scoreGained = Math.floor(BASE_SCORES.great * typeConfig.scoreMultiplier);
  } else if (timing < typeConfig.timingWindow.good) {
    result = 'good';
    scoreGained = Math.floor(BASE_SCORES.good * typeConfig.scoreMultiplier);
  } else {
    result = 'miss';
  }

  if (result !== 'miss') {
    gameState.score += scoreGained;
  }

  const el = document.getElementById('circle-' + circle.id);
  let feedbackX = circle.x, feedbackY = circle.y;
  if (el) {
    const rect = el.getBoundingClientRect();
    const area = document.getElementById('play-area').getBoundingClientRect();
    feedbackX = rect.left - area.left + rect.width / 2;
    feedbackY = rect.top - area.top + rect.height / 2;
  }

  removeCircle(circle.id);
  registerHit(result, feedbackX, feedbackY, circle.type, scoreGained);
}

function registerHit(result, x, y, circleType, scoreGained = 0) {
  gameState.hits[result]++;

  if (result === 'miss') {
    gameState.combo = 0;
  } else {
    gameState.combo++;
    if (gameState.combo > gameState.maxCombo) {
      gameState.maxCombo = gameState.combo;
    }
  }

  document.getElementById('current-score').textContent = gameState.score.toLocaleString();
  document.getElementById('current-combo').textContent =
    gameState.combo > 1 ? `${gameState.combo} COMBO` : '';

  showFeedback(result, x, y, scoreGained);
}

function showFeedback(result, x, y, score = 0) {
  const area = document.getElementById('play-area');
  const feedback = document.createElement('div');
  feedback.className = 'hit-feedback ' + result;
  feedback.textContent = result === 'miss' ? 'MISS' : `${result.toUpperCase()} +${score}`;
  feedback.style.left = x + 'px';
  feedback.style.top = y + 'px';
  area.appendChild(feedback);

  setTimeout(() => feedback.remove(), 500);
}

// ============================================================
// GAME END
// ============================================================
function endGame() {
  gameState.isPlaying = false;
  stopGifBackground();

  const totalNotes = gameState.circles.length;
  const hitNotes = gameState.hits.perfect + gameState.hits.great + gameState.hits.good;
  const accuracy = totalNotes > 0 ? (hitNotes / totalNotes) * 100 : 0;

  let grade, gradeClass;
  if (accuracy >= 95 && gameState.hits.miss === 0) {
    grade = 'S';
    gradeClass = 'grade-s';
  } else if (accuracy >= 85) {
    grade = 'A';
    gradeClass = 'grade-a';
  } else if (accuracy >= 70) {
    grade = 'B';
    gradeClass = 'grade-b';
  } else {
    grade = 'C';
    gradeClass = 'grade-c';
  }

  document.getElementById('result-grade').textContent = grade;
  document.getElementById('result-grade').className = 'result-grade ' + gradeClass;
  document.getElementById('result-score').textContent = gameState.score.toLocaleString();
  document.getElementById('result-combo').textContent = gameState.maxCombo;
  document.getElementById('result-perfect').textContent = gameState.hits.perfect;
  document.getElementById('result-great').textContent = gameState.hits.great;
  document.getElementById('result-good').textContent = gameState.hits.good;
  document.getElementById('result-miss').textContent = gameState.hits.miss;

  saveScore();
  showScreen('result-screen');
}

function retryGame() {
  startGame(gameState.selectedDifficulty);
}

// ============================================================
// RANKING (localStorage)
// ============================================================
function saveScore() {
  const key = `cybertap_ranking_${gameState.selectedSong.id}_${gameState.selectedDifficulty}`;
  let rankings = JSON.parse(localStorage.getItem(key) || '[]');

  rankings.push({
    score: gameState.score,
    combo: gameState.maxCombo,
    date: new Date().toISOString(),
  });

  rankings.sort((a, b) => b.score - a.score);
  rankings = rankings.slice(0, 10);

  localStorage.setItem(key, JSON.stringify(rankings));
}

function renderRanking() {
  const container = document.getElementById('ranking-list');
  const song = SONGS[gameState.rankingSongIndex];
  const diff = gameState.rankingDifficulty;

  // Update title
  document.getElementById('ranking-song-title').textContent = song.title;

  // Update tab active state
  document.querySelectorAll('.ranking-diff-tab').forEach(tab => {
    tab.classList.toggle('active', tab.textContent.toLowerCase() === diff);
  });

  // Get rankings
  const key = `cybertap_ranking_${song.id}_${diff}`;
  const rankings = JSON.parse(localStorage.getItem(key) || '[]');

  container.innerHTML = '';

  if (rankings.length === 0) {
    container.innerHTML = '<div style="color: var(--text-sub); padding: 40px; text-align: center;">No records yet.<br>Play this song!</div>';
    return;
  }

  // Show TOP 10
  rankings.slice(0, 10).forEach((entry, idx) => {
    const item = document.createElement('div');
    item.className = 'ranking-item';

    let rankClass = '';
    if (idx === 0) rankClass = 'gold';
    else if (idx === 1) rankClass = 'silver';
    else if (idx === 2) rankClass = 'bronze';

    item.innerHTML = `
      <div class="rank ${rankClass}">#${idx + 1}</div>
      <div class="info">
        <div class="name">Combo: ${entry.combo}</div>
        <div class="meta">${new Date(entry.date).toLocaleDateString()}</div>
      </div>
      <div class="score">${entry.score.toLocaleString()}</div>
    `;
    container.appendChild(item);
  });
}

function changeRankingSong(direction) {
  gameState.rankingSongIndex = (gameState.rankingSongIndex + direction + SONGS.length) % SONGS.length;
  renderRanking();
}

function changeRankingDiff(diff) {
  gameState.rankingDifficulty = diff;
  renderRanking();
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  document.addEventListener('touchmove', e => {
    if (gameState.isPlaying) e.preventDefault();
  }, { passive: false });
});
</script>

</body>
</html>
